# =============================================================================
# MCP Memory Service - Docker Compose
# =============================================================================
# Démarrage : docker compose up -d
# Logs      : docker compose logs -f mcp-memory
# Arrêt     : docker compose down
# =============================================================================

services:
  # ===========================================================================
  # MCP Memory Service - Serveur principal
  # ===========================================================================
  mcp-memory:
    build: .
    container_name: mcp-memory-service
    ports:
      - "${MCP_SERVER_PORT:-8002}:8002"
    environment:
      # Neo4j
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      # S3
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      # LLMaaS
      - LLMAAS_API_URL=${LLMAAS_API_URL}
      - LLMAAS_API_KEY=${LLMAAS_API_KEY}
      - LLMAAS_MODEL=${LLMAAS_MODEL:-gpt-oss:120b}
      - EXTRACTION_MAX_TEXT_LENGTH=${EXTRACTION_MAX_TEXT_LENGTH:-950000}
      # Embedding
      - LLMAAS_EMBEDDING_MODEL=${LLMAAS_EMBEDDING_MODEL:-bge-m3:567m}
      - LLMAAS_EMBEDDING_DIMENSIONS=${LLMAAS_EMBEDDING_DIMENSIONS:-1024}
      # Qdrant
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION_PREFIX=${QDRANT_COLLECTION_PREFIX:-memory_}
      # Chunking
      - CHUNK_SIZE=${CHUNK_SIZE:-500}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-50}
      # Server config
      - MCP_SERVER_DEBUG=${MCP_SERVER_DEBUG:-false}
      - ADMIN_BOOTSTRAP_KEY=${ADMIN_BOOTSTRAP_KEY}
    depends_on:
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - mcp-network

  # ===========================================================================
  # Neo4j - Base de données graphe
  # ===========================================================================
  neo4j:
    image: neo4j:5-community
    container_name: mcp-memory-neo4j
    ports:
      - "7475:7474"  # Browser UI (http://localhost:7475)
      - "7688:7687"  # Bolt protocol
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
      # Désactiver l'auth pour le dev (optionnel, décommenter si besoin)
      # - NEO4J_AUTH=none
      # Configuration mémoire (ajuster selon vos ressources)
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=1G
      - NEO4J_server_memory_pagecache_size=512m
      # Plugins (APOC pour fonctions avancées)
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - mcp-network

  # ===========================================================================
  # Qdrant - Base de données vectorielle (RAG)
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:v1.16.2
    container_name: mcp-memory-qdrant
    ports:
      - "6333:6333"   # REST API
      - "6334:6334"   # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/6333'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 5s
    restart: unless-stopped
    networks:
      - mcp-network

# =============================================================================
# Volumes persistants
# =============================================================================
volumes:
  neo4j_data:
    name: mcp-memory-neo4j-data
  neo4j_logs:
    name: mcp-memory-neo4j-logs
  qdrant_data:
    name: mcp-memory-qdrant-data

# =============================================================================
# Réseau
# =============================================================================
networks:
  mcp-network:
    name: mcp-memory-network
    driver: bridge
